---
// Main chat interface component
import examples from '../../../config/examples.json';
---

<div id="app" class="hidden flex flex-col h-full">
  <!-- Chat Area -->
  <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4">
    <!-- Empty State -->
    <div class="empty-state text-center py-12" id="empty-state">
      <h2 class="text-2xl font-semibold text-gray-800 mb-2">Welcome to your PKM Assistant</h2>
      <p class="text-gray-600 mb-8">Ask me anything about your notes</p>

      <div class="max-w-md mx-auto space-y-2">
        {examples.map((example) => (
          <button
            class="example-query w-full text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
            onclick={`sendExample('${example.replace(/'/g, "\\'")}')`}
          >
            {example}
          </button>
        ))}
      </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden items-center gap-2 px-6 py-3 bg-white border border-gray-200 rounded-xl max-w-[80%]">
      <div class="w-4 h-4 border-2 border-gray-300 border-t-blue-500 rounded-full animate-spin"></div>
      <span class="text-gray-600">Thinking...</span>
    </div>
  </div>

  <!-- Controls -->
  <div class="flex items-center gap-2 px-4 py-2 bg-white border-t border-gray-200 text-sm">
    <!-- Model Settings Button -->
    <button
      id="model-settings-btn"
      onclick="showModelSettings()"
      class="p-2 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg transition-colors"
      title="Model settings"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
      </svg>
    </button>

    <button
      onclick="showSessionHistory()"
      class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg transition-colors whitespace-nowrap"
    >
      Sessions
    </button>
    <button
      onclick="newSession()"
      class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg transition-colors whitespace-nowrap"
    >
      New
    </button>
  </div>

  <!-- Model Settings Modal -->
  <div id="model-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) hideModelSettings()">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
      <div class="px-6 py-4 border-b flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800">Model Settings</h2>
        <button onclick="hideModelSettings()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <!-- Model Selection -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
          <select
            id="model-select"
            class="w-full px-3 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            onchange="updateModel()"
          >
            <option value="claude-haiku-4-5">Haiku 4.5 (Fast)</option>
            <option value="claude-sonnet-4-5">Sonnet 4.5 (Balanced)</option>
            <option value="claude-opus-4-1">Opus 4.1 (Best)</option>
          </select>
        </div>

        <!-- Deep Thinking Toggle -->
        <div>
          <label class="flex items-center gap-3 cursor-pointer">
            <input
              type="checkbox"
              id="thinking-toggle"
              class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
              onchange="updateThinking()"
            />
            <div>
              <div class="text-sm font-medium text-gray-700">Extended Thinking</div>
              <div class="text-xs text-gray-500">Allow model more time to think</div>
            </div>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="flex gap-2 p-4 bg-white border-t border-gray-200 shadow-lg">
    <textarea
      id="input"
      rows="1"
      placeholder="Ask about your notes..."
      autocomplete="off"
      class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow resize-none overflow-hidden"
      style="max-height: 240px;"
    ></textarea>

    <!-- Voice Input Button -->
    <button
      id="voice-btn"
      type="button"
      aria-label="Voice input"
      title="Tap to start voice input"
      class="px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed self-end voice-button touch-manipulation"
    >
      <!-- Microphone Icon -->
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
      </svg>
    </button>

    <button
      id="send-btn"
      onclick="send()"
      class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed self-end"
    >
      Send
    </button>
  </div>

  <!-- Voice Status Indicator -->
  <div id="voice-status" class="hidden px-4 py-2 bg-blue-50 border-t border-blue-200 text-sm text-blue-700 text-center">
    <span id="voice-status-text">Listening...</span>
  </div>
</div>

<style is:global>
  /* Message bubbles */
  .message {
    padding: 1.5rem;
    border-radius: 0.75rem;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.6;
  }

  .message.user {
    background-color: rgb(59 130 246);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 0.25rem;
    white-space: pre-wrap;
  }

  .message.assistant {
    background-color: white;
    color: rgb(31 41 55);
    border: 1px solid rgb(229 231 235);
    border-bottom-left-radius: 0.25rem;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  }

  /* Typography - tighter spacing */
  .message.assistant > *:first-child {
    margin-top: 0;
  }

  .message.assistant > *:last-child {
    margin-bottom: 0;
  }

  .message.assistant p {
    margin: 0.5em 0;
  }

  /* Headings */
  .message.assistant h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0.75em 0 0.5em 0;
    color: rgb(17 24 39);
    line-height: 1.3;
  }

  .message.assistant h2 {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0.75em 0 0.5em 0;
    color: rgb(17 24 39);
    line-height: 1.3;
  }

  .message.assistant h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0.75em 0 0.5em 0;
    color: rgb(31 41 55);
    line-height: 1.3;
  }

  .message.assistant h4 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0.75em 0 0.5em 0;
    color: rgb(31 41 55);
    line-height: 1.3;
  }

  .message.assistant h5,
  .message.assistant h6 {
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0.75em 0 0.5em 0;
    color: rgb(55 65 81);
    line-height: 1.3;
  }

  /* Lists - tighter spacing */
  .message.assistant ul {
    margin: 0.5em 0;
    padding-left: 1.5em;
    list-style-type: disc;
  }

  .message.assistant ol {
    margin: 0.5em 0;
    padding-left: 1.5em;
    list-style-type: decimal;
  }

  .message.assistant li {
    margin: 0.25em 0;
    display: list-item;
  }

  .message.assistant li > p {
    margin: 0.25em 0;
  }

  /* Nested lists */
  .message.assistant ul ul,
  .message.assistant ol ol,
  .message.assistant ul ol,
  .message.assistant ol ul {
    margin: 0.25em 0;
  }

  /* Code styling */
  .message code {
    background-color: rgb(243 244 246);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: ui-monospace, monospace;
    font-size: 0.875em;
  }

  .message.user code {
    background-color: rgba(255 255 255 / 0.2);
  }

  .message.assistant pre {
    background-color: rgb(243 244 246);
    padding: 0.75rem;
    border-radius: 0.375rem;
    overflow-x: auto;
    margin: 0.75em 0;
  }

  .message.assistant pre code {
    background-color: transparent;
    padding: 0;
    font-size: 0.875em;
  }

  /* Blockquotes */
  .message.assistant blockquote {
    border-left: 4px solid rgb(59 130 246);
    padding-left: 1rem;
    margin: 0.75em 0;
    color: rgb(75 85 99);
    font-style: italic;
  }

  .message.assistant blockquote p {
    margin: 0.25em 0;
  }

  /* Horizontal rules */
  .message.assistant hr {
    border: none;
    border-top: 1px solid rgb(229 231 235);
    margin: 1em 0;
  }

  /* Links */
  .message.assistant a {
    color: rgb(59 130 246);
    text-decoration: none;
  }

  .message.assistant a:hover {
    text-decoration: underline;
  }

  /* Tables */
  .message.assistant table {
    border-collapse: collapse;
    width: 100%;
    margin: 0.75em 0;
    font-size: 0.925em;
  }

  .message.assistant th,
  .message.assistant td {
    border: 1px solid rgb(209 213 219);
    padding: 0.5rem 0.75rem;
    text-align: left;
  }

  .message.assistant th {
    background-color: rgb(243 244 246);
    font-weight: 600;
  }

  /* Text formatting */
  .message.assistant strong {
    font-weight: 600;
    color: rgb(17 24 39);
  }

  .message.assistant em {
    font-style: italic;
  }

  /* Task list items (checkboxes) */
  .message.assistant .task-list-item {
    list-style-type: none;
    position: relative;
  }

  .message.assistant .task-list-item-checkbox {
    margin-right: 0.5em;
    cursor: default;
  }

  .message.assistant .task-list-item input[type="checkbox"]:checked + span {
    text-decoration: line-through;
    color: rgb(107 114 128);
  }

  /* Mobile optimizations */
  @media (max-width: 640px) {
    .message {
      max-width: 90%;
    }

    .message.assistant h1 {
      font-size: 1.375rem;
    }

    .message.assistant h2 {
      font-size: 1.125rem;
    }
  }

  /* Voice button animations */
  .voice-button.recording {
    background-color: rgb(239 68 68) !important;
    color: white !important;
    animation: pulse-red 1.5s ease-in-out infinite;
  }

  .voice-button.recording svg {
    color: white;
  }

  @keyframes pulse-red {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.05); }
  }

  .voice-button.disabled {
    opacity: 0.5;
    cursor: not-allowed !important;
  }

  #voice-status {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
