# PKM Bridge — Claude Code Project Guide

AI-powered Personal Knowledge Management bridge: natural language access to
org-mode files, Google Calendar, and TickTick via Claude, with a modern web UI.

## Architecture

- **Backend**: Python 3.11+ / Flask, serving on port 8000
  - `pkm-bridge-server.py` — main server (PEP-723 inline deps, run directly with uv)
  - `pkm_bridge/` — modules: auth, database, tools, embeddings, voice, integrations
  - `config/` — settings validation, system prompt, user context template
- **Frontend**: Astro 5 + TypeScript + Tailwind CSS 4, built with Bun
  - `frontend/src/pages/` — index.astro (chat+editor UI), settings.astro
  - `frontend/src/components/` — ChatInterface, EditorInterface, LoginForm
  - `frontend/src/utils/VoiceInput.ts` — VAD + Whisper voice input
  - Build output goes to `templates/` (served by Flask in production)
- **Database**: PostgreSQL 16 + pgvector (embeddings for RAG)
- **Docker**: multi-stage Dockerfile (Node for frontend build, Python for runtime)

## Development

```bash
# Backend (terminal 1)
./pkm-bridge-server.py          # Flask on :8000

# Frontend (terminal 2)
cd frontend && bun run dev      # Astro dev server on :4321 with HMR

# Or use the helper script (opens both):
./RUNME-dev.sh
```

The Astro dev server proxies `/api`, `/query`, `/transcribe`, `/sessions`, etc.
to the Flask backend (configured in `frontend/astro.config.mjs`).

Frontend build: `cd frontend && bun run build` (outputs to `../templates/`).

## Deployment

Run `./DEPLOY.sh` to deploy. This SSHs to `docker-server`, pulls latest code,
and runs `docker compose up -d --build` with a 30s log tail.

## Code Style

- **Python**: ruff + black, line-length 100, target py311. Use type hints. Use `uv` for deps.
  - Lint rules: E, F, I (see `pyproject.toml`)
- **TypeScript**: strict mode. Use Bun (not npm).
- Frontend uses Tailwind utility classes; no separate CSS files except `global.css`.

## Key Directories

| Path | Purpose |
|------|---------|
| `pkm-bridge-server.py` | Main Flask server (~1300 lines) |
| `pkm_bridge/` | Backend modules (auth, DB, tools, embeddings, voice, integrations) |
| `pkm_bridge/tools/` | Tool registry + implementations (shell, search, calendar, etc.) |
| `pkm_bridge/embeddings/` | Voyage AI embeddings, incremental pipeline, chunking |
| `config/` | Settings validation, system prompt, user context |
| `frontend/src/` | Astro pages, components, utils |
| `templates/` | Built frontend output (gitignored, generated by `bun run build`) |
| `docker/` | Dockerfile, docker-compose.yml, entrypoint, postgres-init |
| `Documentation/` | README, PROJECT, GETTING_STARTED, AUTH_SETUP, etc. |
| `tests/` | Committed tests |
| `tests_local/` | Local integration tests (gitignored) |

## Environment

Config via `.env` (or `.env.local` for local dev overrides). Key variables:

- `ANTHROPIC_API_KEY` — required
- `ORG_DIR`, `LOGSEQ_DIR` — paths to knowledge base
- `DATABASE_URL` — PostgreSQL connection string
- `GROQ_API_KEY` + `STT_PROVIDER=groq` — voice transcription (Whisper)
- `VOYAGE_API_KEY` — RAG embeddings
- `AUTH_ENABLED`, `JWT_SECRET`, `PASSWORD_HASH` — authentication
- Google Calendar / TickTick OAuth keys — see `Documentation/` for setup

## Testing

```bash
# Run committed tests
pytest tests/

# Local integration tests (not in git)
pytest tests_local/
```

## Common Tasks

- **Add a new tool**: Create a class in `pkm_bridge/tools/` extending `BaseTool`, it auto-registers via the registry.
- **Add a proxy route for dev**: Add to `frontend/astro.config.mjs` → `vite.server.proxy`.
- **Voice input**: Client-side VAD (`@ricky0123/vad-web`) detects speech, encodes WAV, POSTs to `/transcribe` endpoint which proxies to Groq Whisper.
- **Embeddings**: Run `python scripts/embed_notes.py` for manual embedding, or let the hourly APScheduler job handle it.
